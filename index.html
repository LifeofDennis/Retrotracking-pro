<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="utf-8" />
    <title>Retrotrack Pro | Intelligence</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
      <link rel="icon" type="image/png" href="/img/Retro.png" sizes="96x96" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .glass { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12.5px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transition: all 300ms; }
        .glass-toast { background-color: rgb(15, 23, 42); border: 1px solid rgb(30, 41, 59); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); backdrop-filter: blur(20px); }
        .card-hover { transition: all 200ms; } .card-hover:hover { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border-color: rgb(191, 219, 254); transform: translateY(-4px); } .card-hover:active { transform: translateY(0); }
        .chart-container { position: relative; height: 320px; width: 100%; }
        @keyframes slideUp {
            from { transform: translate(-50%, 40px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-toast { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body class="h-full font-sans antialiased text-slate-900" x-data="bizTrack()">

<header class="sticky top-0 z-50 bg-white/70 backdrop-blur-lg border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-700 rounded-xl flex items-center justify-center shadow-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
        </div>
        <div>
            <h1 class="font-black text-xl tracking-tight leading-none text-blue-900 uppercase">Retrotrack <span class="text-blue-500 font-light italic">Pro</span></h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Classic accounting. Modern intelligence.</p>
        </div>
    </div>
    <button @click="openQuickAdd()" class="bg-blue-700 hover:bg-blue-800 text-white font-black text-xs px-5 py-2.5 rounded-lg shadow-sm active:scale-95 transition-all uppercase tracking-wider flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
        Add Entry
    </button>
</header>

<main class="max-w-6xl mx-auto p-6 pb-24 space-y-8">
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="glass p-5 rounded-2xl border-t-4 border-t-blue-700">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Lifetime Net Worth</p>
            <h2 class="text-2xl font-black text-blue-900 tabular-nums" x-text="format(netValue)"></h2>
        </div>
        <div class="glass p-5 rounded-2xl border-l-4 border-l-emerald-500">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Income (<span x-text="monthName.split(' ')[0]"></span>)</p>
            <h2 class="text-2xl font-black text-emerald-600 tabular-nums" x-text="format(cashFlowData.inflow)"></h2>
        </div>
        <div class="glass p-5 rounded-2xl border-l-4 border-l-rose-500">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Expenses (<span x-text="monthName.split(' ')[0]"></span>)</p>
            <h2 class="text-2xl font-black text-rose-600 tabular-nums" x-text="format(cashFlowData.outflow)"></h2>
        </div>
        <div class="glass p-5 rounded-2xl border-l-4 border-l-amber-500">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Monthly Margin</p>
            <h2 class="text-2xl font-black text-amber-700 tabular-nums" x-text="profitMargin + '%'"></h2>
        </div>
    </section>

    <nav class="flex bg-slate-200/50 p-1.5 rounded-xl max-w-sm mx-auto shadow-inner">
        <template x-for="tab in ['ledger', 'cashflow', 'analytics']">
            <button @click="currentTab = tab" :class="currentTab === tab ? 'bg-white shadow-md text-blue-700 font-black' : 'text-slate-500 font-bold hover:text-slate-700'" class="flex-1 py-2 rounded-lg text-[10px] uppercase tracking-widest transition-all" x-text="tab"></button>
        </template>
    </nav>

    <section x-show="currentTab === 'ledger'" x-transition class="space-y-6">
        <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between">
            <div class="relative w-full md:w-1/3">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></span>
                <input type="text" x-model="searchQuery" placeholder="Search entries..." class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm" />
            </div>
            
            <div class="flex items-center gap-3" x-data="{ open: false }">
                <div class="relative">
                    <button @click="open = !open" class="flex items-center gap-2 rounded-xl border border-slate-200 px-4 py-2 font-black text-[11px] uppercase text-blue-800 bg-blue-50/50 hover:bg-blue-100 transition-all">
                        <span x-text="monthName"></span>
                        <svg class="w-3 h-3 transition-transform" :class="open ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div x-show="open" @click.outside="open = false" x-transition class="absolute top-full mt-2 right-0 w-64 bg-white border border-slate-200 shadow-2xl rounded-2xl z-[150] p-4">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <button @click="changeYear(-1)" class="p-1 hover:bg-slate-100 rounded text-blue-700 font-bold px-2">â€¹</button>
                            <span class="font-black text-blue-900" x-text="viewMonth.split('-')[0]"></span>
                            <button @click="changeYear(1)" class="p-1 hover:bg-slate-100 rounded text-blue-700 font-bold px-2">â€º</button>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <template x-for="(m, index) in ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']">
                                <button @click="viewMonth = `${viewMonth.split('-')[0]}-${String(index + 1).padStart(2, '0')}`; open = false;"
                                        :class="viewMonth.endsWith(String(index + 1).padStart(2, '0')) ? 'bg-blue-700 text-white' : 'hover:bg-blue-50 text-slate-600'"
                                        class="py-2 rounded-lg text-[10px] font-black uppercase transition-colors" x-text="m"></button>
                            </template>
                        </div>
                    </div>
                </div>
                <div class="flex gap-1 bg-slate-100 p-1 rounded-xl border">
                    <button @click="$refs.fileInput.click()" class="p-2 text-slate-500 hover:text-emerald-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg></button>
                    <input type="file" x-ref="fileInput" class="hidden" accept=".csv" @change="importCSV($event)">
                    <button @click="exportCSV()" class="p-2 text-slate-500 hover:text-blue-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
                </div>
            </div>
        </div>

        <div class="grid gap-3">
            <template x-for="rec in filteredRecords" :key="rec.id">
                <div @click="editRecord(rec)" class="glass p-5 rounded-2xl flex items-center justify-between card-hover cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div :class="rec.type === 'revenue' ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'" class="w-12 h-12 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                        <div>
                            <h4 class="font-black text-slate-800" x-text="rec.desc"></h4>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" x-text="rec.category + ' â€¢ ' + rec.date"></p>
                        </div>
                    </div>
                    <p class="text-lg font-black tabular-nums" :class="rec.type === 'revenue' ? 'text-emerald-600' : 'text-rose-600'" x-text="format(rec.amount)"></p>
                </div>
            </template>
        </div>
    </section>

    <section x-show="currentTab === 'cashflow'" x-transition class="max-w-2xl mx-auto space-y-6">
        <div class="glass p-10 rounded-[2.5rem] space-y-8">
            <div class="border-b border-slate-100 pb-6 text-center">
                <h2 class="text-2xl font-black text-blue-900 uppercase">Retrotrack Cash Flow</h2>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Unified Accounting View</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Fiscal Year <span x-text="viewMonth.split('-')[0]"></span></p>
                    <div class="flex flex-col mt-1">
                        <span class="text-xs font-bold text-emerald-600" x-text="'+' + format(yearlyData.inflow)"></span>
                        <span class="text-xs font-bold text-rose-600" x-text="'-' + format(yearlyData.outflow)"></span>
                        <div class="mt-2 pt-2 border-t border-slate-200">
                            <span class="text-sm font-black text-blue-900" x-text="format(yearlyData.net)"></span>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-900 p-5 rounded-2xl shadow-lg border border-blue-800">
                    <p class="text-[9px] font-black text-blue-300 uppercase tracking-widest mb-1">Lifetime Overall</p>
                    <h3 class="text-xl font-black text-white tabular-nums mt-2" x-text="format(netValue)"></h3>
                    <p class="text-[9px] text-blue-400 font-bold uppercase mt-1">Cumulative Net Worth</p>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between items-end">
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Yearly Burn Rate</p>
                    <p class="text-xs font-black text-slate-900" x-text="((yearlyData.outflow / (yearlyData.inflow || 1)) * 100).toFixed(1) + '%'"></p>
                </div>
                <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden flex">
                    <div class="bg-emerald-500 h-full transition-all duration-1000" :style="`width: ${Math.max(0, 100 - (yearlyData.outflow / (yearlyData.inflow || 1)) * 100)}%`"></div>
                    <div class="bg-rose-500 h-full transition-all duration-1000" :style="`width: ${Math.min(100, (yearlyData.outflow / (yearlyData.inflow || 1)) * 100)}%`"></div>
                </div>
            </div>
        </div>
    </section>

    <section x-show="currentTab === 'analytics'" x-transition class="space-y-10">
        <div class="glass p-8 rounded-3xl"><div class="chart-container"><canvas id="mainChart"></canvas></div></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
            <div class="glass p-8 rounded-3xl"><div class="chart-container !h-[280px]"><canvas id="categoryChart"></canvas></div></div>
            <div class="glass p-8 rounded-3xl">
                <h3 class="text-[10px] font-black uppercase text-slate-400 mb-6 tracking-widest">Expense Intensity</h3>
                <div class="space-y-5">
                    <template x-for="stat in categoryStats">
                        <div class="space-y-1.5">
                            <div class="flex justify-between text-[11px] font-black uppercase"><span class="text-slate-600" x-text="stat.name"></span><span class="text-slate-900" x-text="format(stat.value)"></span></div>
                            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden"><div class="bg-blue-600 h-full transition-all duration-700" :style="`width: ${Math.min((stat.value / (cashFlowData.outflow || 1)) * 100, 100)}%`"></div></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </section>
</main>

<div x-show="modalOpen" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm" x-cloak x-transition>
    <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 space-y-8 shadow-2xl">
        <div class="flex justify-between items-center"><h2 class="text-xl font-black text-blue-900 uppercase">Retrotrack Form</h2><button @click="modalOpen = false" class="text-slate-300 hover:text-rose-500 text-2xl">âœ•</button></div>
        <div class="flex p-1.5 bg-slate-100 rounded-2xl">
            <button @click="form.type='revenue'" :class="form.type==='revenue'?'bg-white text-emerald-700 shadow-md':'text-slate-500'" class="flex-1 py-3 font-black text-[10px] uppercase rounded-xl transition-all">Income</button>
            <button @click="form.type='expense'" :class="form.type==='expense'?'bg-white text-rose-700 shadow-md':'text-slate-500'" class="flex-1 py-3 font-black text-[10px] uppercase rounded-xl transition-all">Expense</button>
        </div>
        <div class="grid gap-5">
            <select x-model="form.category" class="w-full bg-slate-50 border-slate-200 p-4 rounded-2xl font-bold text-sm">
                <template x-for="cat in (form.type === 'revenue' ? incomeCategories : expenseCategories)"><option :value="cat" x-text="cat"></option></template>
            </select>
            <input x-model="form.desc" placeholder="Details" class="w-full border-slate-200 p-4 rounded-2xl font-bold text-sm shadow-inner" />
            <div class="grid grid-cols-2 gap-5">
                <input x-model.number="form.amount" type="number" placeholder="Amount" class="w-full border-slate-200 p-4 rounded-2xl font-black text-blue-700" />
                <input x-model="form.date" type="date" class="w-full border-slate-200 p-4 rounded-2xl font-bold text-xs" />
            </div>
        </div>
        <div class="flex gap-4">
            <button @click="saveRecord()" class="flex-[3] bg-blue-700 text-white py-5 rounded-3xl font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">Settle Record</button>
            <button x-show="form.id" @click="deleteRecord()" class="flex-1 bg-rose-50 text-rose-600 rounded-3xl flex items-center justify-center">ðŸ—‘</button>
        </div>
    </div>
</div>

<div x-show="showToast" x-cloak class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] animate-toast">
    <div class="glass-toast px-8 py-4 rounded-2xl flex items-center gap-4">
        <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <div>
            <p class="text-white font-black text-xs uppercase tracking-widest">Database Sync</p>
            <p class="text-slate-400 text-[10px] font-bold">Retrotrack ledger updated.</p>
        </div>
    </div>
</div>

<script>
function bizTrack() {
    return {
        currentTab: 'ledger',
        modalOpen: false,
        showToast: false,
        searchQuery: '',
        viewMonth: new Date().toISOString().slice(0, 7),
        transactions: [],
        mainChart: null,
        catChart: null,
        incomeCategories: ['Sales', 'Service Income', 'Interest', 'Investment', 'Other'],
        expenseCategories: ['Salaries', 'Rent', 'Inventory', 'Marketing', 'Utilities', 'Transport', 'Taxes', 'Office', 'Repairs'],
        form: { id: null, type: 'revenue', desc: '', amount: '', date: '', category: 'Sales' },

        init() {
            this.transactions = JSON.parse(localStorage.getItem('biztrack_v5_pro') || '[]');
            this.$watch('currentTab', val => { if(val === 'analytics') this.$nextTick(() => this.renderCharts()); });
            this.$watch('viewMonth', () => { if(this.currentTab === 'analytics') this.renderCharts(); });
        },

        get filteredRecords() {
            return this.transactions.filter(t => t.date.startsWith(this.viewMonth) && t.desc.toLowerCase().includes(this.searchQuery.toLowerCase())).sort((a,b) => new Date(b.date) - new Date(a.date));
        },

        get netValue() { 
            return this.transactions.reduce((sum, t) => sum + (t.type === 'revenue' ? t.amount : -t.amount), 0); 
        },
        
        get yearlyData() {
            const currentYear = this.viewMonth.split('-')[0];
            let inflow = 0, outflow = 0;
            this.transactions.forEach(t => {
                if (t.date.startsWith(currentYear)) {
                    t.type === 'revenue' ? inflow += t.amount : outflow += t.amount;
                }
            });
            return { inflow, outflow, net: inflow - outflow };
        },

        get profitMargin() { 
            const { inflow, outflow } = this.cashFlowData; 
            return inflow === 0 ? 0 : (((inflow - outflow) / inflow) * 100).toFixed(1); 
        },
        
        get categoryStats() {
            const stats = {};
            this.transactions.filter(t => t.date.startsWith(this.viewMonth) && t.type === 'expense').forEach(t => stats[t.category] = (stats[t.category] || 0) + t.amount);
            return Object.entries(stats).map(([name, value]) => ({name, value})).sort((a,b) => b.value - a.value);
        },

        get cashFlowData() {
            const startOfMonth = new Date(this.viewMonth + "-01");
            let opening = 0, inflow = 0, outflow = 0;
            this.transactions.forEach(t => {
                const tDate = new Date(t.date);
                if (tDate < startOfMonth) opening += (t.type === 'revenue' ? t.amount : -t.amount);
                else if (t.date.startsWith(this.viewMonth)) t.type === 'revenue' ? inflow += t.amount : outflow += t.amount;
            });
            return { opening, inflow, outflow, closing: opening + inflow - outflow };
        },

        get monthName() { return new Date(this.viewMonth + "-01").toLocaleString('default', { month: 'long', year: 'numeric' }); },

        changeYear(offset) {
            let d = new Date(this.viewMonth + "-01");
            d.setFullYear(d.getFullYear() + offset);
            this.viewMonth = d.toISOString().slice(0, 7);
        },

        openQuickAdd() { 
            const selectedMonth = this.viewMonth; 
            const today = new Date().toISOString().slice(0, 10);
            let defaultDate = today.startsWith(selectedMonth) ? today : `${selectedMonth}-01`;
            this.form = { id: null, type: 'revenue', desc: '', amount: '', date: defaultDate, category: 'Sales' }; 
            this.modalOpen = true; 
        },

        editRecord(rec) { this.form = { ...rec }; this.modalOpen = true; },
        saveRecord() {
            if(!this.form.desc || !this.form.amount) return;
            this.form.id ? this.transactions[this.transactions.findIndex(t => t.id === this.form.id)] = {...this.form} : (this.form.id = Date.now(), this.transactions.push({...this.form}));
            this.triggerUpdate(); this.modalOpen = false;
        },
        deleteRecord() { if(confirm('Delete?')) { this.transactions = this.transactions.filter(t => t.id !== this.form.id); this.triggerUpdate(); this.modalOpen = false; } },
        triggerUpdate() { this.persist(); this.showToast = true; setTimeout(() => this.showToast = false, 3000); },
        persist() { localStorage.setItem('biztrack_v5_pro', JSON.stringify(this.transactions)); },
        format(v) { return 'TSh ' + Number(v).toLocaleString(); },
        exportCSV() {
            let csv = "Date,Description,Category,Type,Amount\n" + this.transactions.map(t => `${t.date},${t.desc},${t.category},${t.type},${t.amount}`).join("\n");
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = `Retrotrack_Data.csv`; a.click();
        },
        importCSV(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split("\n");
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const [date, desc, category, type, amount] = lines[i].split(",");
                    this.transactions.push({ id: Date.now() + i, date: date.trim(), desc: desc.trim(), category: category.trim(), type: type.trim(), amount: parseFloat(amount) });
                }
                this.triggerUpdate();
            };
            reader.readAsText(file);
        },
        renderCharts() {
            const labels = [], revData = [], expData = [];
            for(let i=5; i>=0; i--) {
                let d = new Date(this.viewMonth + "-01"); d.setMonth(d.getMonth() - i);
                let mKey = d.toISOString().slice(0,7);
                labels.push(d.toLocaleString('default', {month:'short'}));
                let r = 0, e = 0;
                this.transactions.filter(t => t.date.startsWith(mKey)).forEach(t => t.type === 'revenue' ? r += t.amount : e += t.amount);
                revData.push(r); expData.push(e);
            }
            if(this.mainChart) this.mainChart.destroy();
            this.mainChart = new Chart(document.getElementById('mainChart'), { type: 'line', data: { labels, datasets: [{ label: 'Income', data: revData, borderColor: '#10b981', tension: 0.4 }, { label: 'Expenses', data: expData, borderColor: '#f43f5e', tension: 0.4 }] }, options: { maintainAspectRatio: false } });
            
            const catCtx = document.getElementById('categoryChart');
            if(catCtx) {
                const catStats = this.categoryStats;
                if(this.catChart) this.catChart.destroy();
                this.catChart = new Chart(catCtx, { type: 'doughnut', data: { labels: catStats.map(s => s.name), datasets: [{ data: catStats.map(s => s.value), backgroundColor: ['#1d4ed8', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] }, options: { maintainAspectRatio: false } });
            }
        }
    }
}
</script>
</body>
</html>